<h2>My Properties</h2>
<a mat-flat-button color="primary" routerLink="/owner/add">Add Property</a>

<div *ngIf="loading">Loading...</div>

<div class="grid">
  <mat-card class="prop" *ngFor="let p of list">
    <img *ngIf="p.images?.length" [src]="'http://localhost:5264' + p.images[0].imageUrl" alt="cover" />
    <mat-card-title>{{ p.title }}</mat-card-title>
    <mat-card-subtitle>{{ p.city }}, {{ p.country }}</mat-card-subtitle>
    <div>â‚¹ {{ p.pricePerNight }} / night</div>

    <!-- OWNER ACTION BUTTONS -->
    <div class="owner-actions">
      <button mat-flat-button color="accent" (click)="edit(p)">Edit</button>
      <button mat-flat-button color="warn" (click)="delete(p.id)">Delete</button>
      <button mat-flat-button color="primary" (click)="openMessages(p.id)">View Messages</button>
    </div>
  </mat-card>
</div>

<!--Added: Messages Modal -->
<div *ngIf="selectedPropertyId" class="messages-modal">
  <div class="modal-content">

    <h3>Messages for {{ selectedProperty?.title }}</h3>

    <div *ngIf="messages[selectedPropertyId]?.length; else noMsg">
      <div *ngFor="let m of messages[selectedPropertyId]" class="message">
        <p><strong>{{ m.senderId === auth.userId ? 'You' : 'Renter' }}:</strong> {{ m.content }}</p>

        <!-- Reply Section -->
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Reply</mat-label>
          <textarea matInput rows="2" [(ngModel)]="replyMessages[m.id]"></textarea>
        </mat-form-field>

        <!-- UPDATED: pass the full message object instead of senderId -->
        <button mat-flat-button color="accent"
                (click)="sendReply(m, selectedPropertyId, m.id)">
                Reply
              </button>
      </div>
    </div>

    <ng-template #noMsg><p>No messages yet.</p></ng-template>
    <button mat-button color="warn" (click)="closeMessages()">Close</button>
  </div>
</div>
